# Global settings
{
    # Enable automatic HTTPS
    email admin@kijumbesmart.co.tz
    acme_ca https://acme-v02.api.letsencrypt.org/directory
}

# Main domain - handles both HTTP and HTTPS
kijumbesmart.co.tz, www.kijumbesmart.co.tz {
    # Redirect www to non-www
    @www {
        host www.kijumbesmart.co.tz
    }
    redir @www https://kijumbesmart.co.tz{uri} permanent

    # Handle ACME challenge for Let's Encrypt
    .well-known/acme-challenge/* {
        root * /var/www/html
        file_server
    }

    # Redirect HTTP to HTTPS
    redir https://kijumbesmart.co.tz{uri} permanent
}

# HTTPS configuration
kijumbesmart.co.tz:443 {
    # Main application (frontend + API)
    handle {
        reverse_proxy switch-app:2025 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
            
            # WebSocket support
            header_up Connection {>Connection}
            header_up Upgrade {>Upgrade}
        }
    }

    # Socket.IO WebSocket
    handle_path /socket.io/* {
        reverse_proxy switch-app:2025 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up Connection {>Connection}
            header_up Upgrade {>Upgrade}
        }
    }

    # XMPP WebSocket (ejabberd)
    handle_path /xmpp-ws/* {
        reverse_proxy ejabberd:5280 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up Connection {>Connection}
            header_up Upgrade {>Upgrade}
        }
    }

    # Janus WebSocket
    handle_path /janus-ws/* {
        reverse_proxy janus:8188 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up Connection {>Connection}
            header_up Upgrade {>Upgrade}
        }
    }
    
    # Janus HTTP API
    handle_path /janus/* {
        reverse_proxy janus:8088 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
        }
    }
}

# Port 2025 - Direct access to application
:2025 {
    handle {
        reverse_proxy switch-app:2025 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up Connection {>Connection}
            header_up Upgrade {>Upgrade}
        }
    }
}
